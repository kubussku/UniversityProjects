---
title: Zastosowanie uogÃ³lnionych modeli liniowych w analizie zrÃ³Å¼nicowania ryzyka
  braku aktywnoÅ›ci konta bankowego.
author: "Piotr Zawadzki, Jakub Kur"
date: "20 06 2021"
output:
  html_document: default
---
<style>
body {
text-align: justify}
</style>


#### ***Spis Tresci:*** <br/>
Wstep<br/>
1. Analiza wstepna zbioru danych [Zawadzki, Kur] <br/>
2. WybÃ³r zmiennych objaÅ›niajÄ…cych do modelu [Zawadzki]<br/>
3. Model Logitowy [Zawadzki]<br/>
4. Model Probitowy [Kur]<br/>
5. Ocena i PorÃ³wnanie Modeli logit / probit [Kur, Zawadzki]<br/>
Podsumowanie [Kur]<br/>
PrÃ³by ulepszenia [Kur]<br/>

#### ***WstÄ™p***<br/>
ZbiÃ³r danych Bank Churn Data Model zostaÅ‚ pobrany ze strony [kaggle.com](https://www.kaggle.com/). Zestaw danych skÅ‚ada siÄ™ z losowo dobranej populacji klientÃ³w banku wraz z informacjami dotyczÄ…cymi danych demograficznych oraz statusu aktywnoÅ›ci konta bankowego.  <br/>
W omawianym projekcie zbudowane zostaÅ‚y modele logitowy i probitowy, a takÅ¼e zostaÅ‚o przeprowadzone ich porÃ³wnanie i interpretacja, wraz z ocenÄ… efektÃ³w interakcji miÄ™dzy zmiennymi niezaleÅ¼nymi. Mimo, Å¼e informacje o zestawie danych wskazuja ze jest to zestaw, ktÃ³ry ma pomÃ³c zdeterminowac klientÃ³w naraÅ¼onych na ryzyko odejscia z banku podjelismy decyzje, Å¼e sprÃ³bÃ³jemy zbadac go pod innym katem. Dlatego analizowane bylo ryzyko braku aktywnoÅ›ci na koncie bankowym. <br/>

#### ***Analiza wstepna zbioru danych:*** <br/> 
ZbiÃ³r danych Bank Churn_Data_Model zawiera 10 000 obserwacji oraz 14 zmiennych: <br/>
**RowNumber** â€“ numer porzÄ…dkowy klienta banku zbiorze danych Bank Churn_Data_Model (zmienna jakoÅ›ciowa przedstawiona na skali nominalnej); <br/>
**CustomerId** â€“ identyfikator klienta banku (zmienna jakoÅ›ciowa przedstawiona na skali nominalnej); <br/>
**Surname** â€“ nazwisko klienta banku (zmienna jakoÅ›ciowa przedstawiona na skali nominalnej); <br/>
**CreditScore** â€“ scoring kredytowy klientÃ³w banku w przedziale od 350 do 850 punktÃ³w (zmienna iloÅ›ciowa przedstawiona na skali ilorazowej); <br/>
**Geography** â€“ kraje, z ktÃ³rych pochodzÄ… klienci banku (Francja, Hiszpania lub Niemcy) (zmienna jakoÅ›ciowa przedstawiona na skali nominalnej); <br/>
**Gender** â€“ zawiera pÅ‚eÄ‡ klienta banku (zmienna jakoÅ›ciowa dychotomiczna, przedstawiona na skali nominalnej); <br/>
**Age** â€“ wiek klienta, w przedziale od 18 do 92 lat (zmienna iloÅ›ciowa przedstawiona na skali ilorazowej); <br/>
**Tenure** â€“ liczba lat ktÃ³re klient przynaleÅ¼y do banku (zmienna iloÅ›ciowa przedstawiona na skali ilorazowej); <br/>
**Balance** â€“ saldo bankowe klienta, w zakresie â‚¬0 - â‚¬250 898 (zmienna iloÅ›ciowa przedstawiona na skali ilorazowej); <br/>
**NumOfProducts** â€“ liczba produktÃ³w bankowych, w posiadaniu klienta, w zakresie od 1 do 4 (zmienna iloÅ›ciowa przedstawiona na skali ilorazowej); <br/>
**HasCrCard** â€“ zmienna dychotomiczna, przyjmujÄ…ca wartoÅ›Ä‡ 1 â€“ dla klientÃ³w posiadajÄ…cych kartÄ™ kredytowÄ… oraz 0 dla klientÃ³w nieposiadajÄ…cych takiej karty (zmienna jakoÅ›ciowa przedstawiona na skali nominalnej);<br/>
**IsActiveMember** â€“ zmienna dychotomiczna, przyjmujÄ…ca wartoÅ›ci 1 â€“ dla klientÃ³w, korzystajÄ…cych z konta bankowego oraz 0 â€“ dla klientÃ³w niekorzystajÄ…cych z takiego konta (zmienna jakoÅ›ciowa przedstawiona na skali nominalnej);<br/>
**EstimatedSalary** â€“ przybliÅ¼ona pensja klientÃ³w banku w zakresie od â‚¬11,58 do â‚¬199 992,5 (zmienna iloÅ›ciowa przedstawiona na skali ilorazowej);<br/>
<br/>
Dane nie zawieraÅ‚y Å¼adnych brakÃ³w ani oczywistych bÅ‚Ä™dÃ³w w strukturze danych. Zmienne RowNumber, CustomerID oraz Surname nie bÄ™dÄ… rozwaÅ¼ane w kontekÅ›cie dalszej budowy modelu, jako Å¼e majÄ… charakter czysto opisowy.
Celem pracy jest zbadanie jakie czynniki wpÅ‚ywajÄ… na szansÄ™ posiadania nieaktywnego konta bankowego (IsActiveMember). WedÅ‚ug bazy danych, ktÃ³ra posÅ‚uÅ¼y nam do budowy modelu, prawie poÅ‚owa badanych klientÃ³w posiadaÅ‚a nieaktywne konto (4849 z 10000; 48,5%).<br/>

#### ***Biblioteki:*** <br/>
```{r message=FALSE, warning=FALSE}
library("car") # funkcja vif()
library("MASS") # funkcja rlm() regresja odporna
library("lmtest") # testy diagnostyczne modeli lm
library("pscl") #pseudo-R2 funkcja pR2()
library("pROC") #funkcje roc, auc
library(summarytools) #summary tools
library("snpar")
library(papeR) # summary stats - lepszy wyglad tablicy
library(kableExtra) #table formatting
library(tidyverse) #data wrangling
library(ggplot2)
```
#### ***Zaladowanie zestawu danych:*** <br/>
```{r}
setwd("F:/ug ekonometria mgr/II/modele nieparametryczne/projekt")
dane1 <- read.table("Churn-Modeling4.csv", header = TRUE, sep = ",", dec = ".")
```
#### ***Ustawienie zmiennych jakosciowych w zestawie:*** <br/>
```{r}
dane1$Gender <- as.factor(dane1$Gender)
dane1$HasCrCard <- as.factor(dane1$HasCrCard)
dane1$IsActiveMember <- as.factor(dane1$IsActiveMember)
dane1$Geography <- as.factor(dane1$Geography)
levels(dane1$Gender) = c("Female","Male")
levels(dane1$Geography) = c("France","Germany","Spain")
```
#### ***Zmienne jakosciowe:*** <br/>
```{r echo=FALSE}
data.frame(freq(dane1$Geography)[,1:4]) %>%
  kbl(caption = "Tablica 1 - LiczebnoÅ›Ä‡ klientÃ³w banku wedÅ‚ug kraju pochodzenia") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
Na podstawie tabeli oraz wykresu widaÄ‡, Å¼e wiÄ™kszoÅ›Ä‡ klientÃ³w w bazie stanowiÄ… Francuzi, natomiast Niemcy oraz Hiszpanie stanowiÄ… po okoÅ‚o 25% klientÃ³w z bazy.
<br/>
```{r echo=FALSE}
data.frame(freq(dane1$Gender)[,1:4]) %>%
  kbl(caption = "Tablica 2 - LiczebnoÅ›Ä‡ klientÃ³w banku wedÅ‚ug pÅ‚ci") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
WedÅ‚ug informacji zawartych w Tabeli 2, mÄ™Å¼czyÅºni stanowiÄ… 54,6% klientÃ³w z bazy danych, natomiast kobiety 45,4%.
<br/>
```{r echo=FALSE}
data.frame(freq(dane1$HasCrCard)[,1:4]) %>%
  kbl(caption = "Tablica 3 - Liczba klientÃ³w nieposiadajÄ…cych oraz posiadajÄ…cych kartÄ™ kredytowÄ… (1 - posiada, 0 - nie posiada)") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
WiÄ™kszoÅ›Ä‡ klientÃ³w z bazy posiada kartÄ™ kredytowÄ…, poniewaÅ¼ stanowiÄ… oni ponad 70% caÅ‚kowitej liczebnoÅ›ci prÃ³by.<br/>

#### ***Zmienne ilosciowe:***
```{r echo=FALSE, message=FALSE, warning=FALSE}

descr(dane1)[1:7,1:6] %>%
kbl(caption = "Tablica 4 - Podstawowe statystki dla zmiennych iloÅ›ciowych") %>%
  kable_classic(full_width = F, html_font = "Cambria")


```
<br/>
Jak widaÄ‡ zmienna Balance nie bÄ™dzie stanowiÄ‡ dobrej zmiennej dla modelu, poniewaÅ¼ jej odchylenie standardowe nie rÃ³Å¼ni siÄ™ znacznie od jej Å›redniej. W bazie na tym etapie zastosowaliÅ›my juÅ¼ nowÄ… zmiennÄ… AgeNew, gdzie od wieku odjÄ™liÅ›my najniÅ¼szy posiadaczy konta, czyli 18 lat. Åšredni wiek klientÃ³w w bazie to wiÄ™c okoÅ‚o 39 lat. Åšrednia punktacja kredytowa to natomiast 650 i nie rÃ³Å¼ni siÄ™ zbytnio od mediany, ktÃ³ra wynosi 652.
<br/>
```{r,fig.align='center'}
ggplot(dane1, aes(x=CreditScoreNew)) + 
    geom_histogram(aes(y=..density..),     
                   binwidth=10,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="blue") + theme_classic()+ ylab("Gestosc")
```
<br/>
Widzimy, Å¼e wielu klientÃ³w posiada maksymalnÄ… punktacjÄ™ kredytowÄ… w danym banku, natomiast oprÃ³cz punktacji rÃ³wnej 850, rozkÅ‚ad zmiennej przypomina rozkÅ‚ad normalny.
<br

#### ***Wybor zmiennych do modelu:*** <br/>
Przy budowaniu uogÃ³lnionych modeli liniowych, speÅ‚nione powinny byÄ‡ nastÄ™pujÄ…ce zaÅ‚oÅ¼enia:<br/>
1) obserwacje sÄ… niezaleÅ¼ne;<br/>
2) wartoÅ›ci zmiennych niezaleÅ¼nych sÄ… ustalone (nie sÄ… losowe), a zmienna zaleÅ¼na jest losowÄ… tylko wyÅ‚Ä…cznie z powodu wystÄ™powania skÅ‚adnika losowego;<br/>
3) zmienne objaÅ›niajÄ…ce nie sÄ… ze sobÄ… skorelowane.<br/>
Å»eby zbadaÄ‡ wspÃ³Å‚zaleÅ¼noÅ›Ä‡ cech, powinnyÅ›my zbudowaÄ‡ macierz korelacji. WspÃ³Å‚czynniki korelacji liniowej Pearsona moÅ¼emy uÅ¼ywaÄ‡ tylko w stosunku do zmiennych iloÅ›ciowych.
```{r}
round(cor(dane1[,c("CreditScoreNew","AgeNew","Tenure","Balance","NumOfProductsNew","EstimatedSalary")]),3) %>%
  kbl(caption = "Tablica 5 - Macierz korelacji liniowej Pearsona dla zmiennych iloÅ›ciowych") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
Utworzona zostaÅ‚a macierz korelacji liniowej Pearsona (Tablica 5) dla zmiennych iloÅ›ciowych. Zmienne objaÅ›niajÄ…ce nie sÄ… nadmiernie skorelowane (|r|â‰¥0,7). <br/>
Statystycznie istotne wspÃ³Å‚czynniki korelacji liniowej: <br/>
Balance - NumOfProductsNew <br/>
<br/>
Utworzono model logitowy ze wszystkimi zmiennymi. Gdzie zmienna Objasniana to **IsActiveMember** . <br/>
```{r}
#Model logitowy
logit0 <- glm(IsActiveMember ~., data=dane1, family=binomial)
#wskaÄ¹ÅŸnik wariancji inflacyjnej
data.frame(vif(logit0)) %>%
  kbl(caption = "Tablica 6 - WskaÅºnik rozdÄ™cia wariancji, miara wspÃ³Å‚liniowoÅ›ci zmiennych objaÅ›niajÄ…cych") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
Jak widaÄ‡ na podstawie Tabeli 6 wartoÅ›ci wszystkich czynnikÃ³w sÄ… bliskie jednoÅ›ci, co oznacza, Å¼e nie sÄ… wspÃ³Å‚liniowe. WartoÅ›ciÄ… granicznÄ… przyjmowanÄ… w przypadku modeli GLM jest 2,5.<br/>
<br/>
<br/>
W celu znalezienia wspÃ³Å‚zaleÅ¼noÅ›ci miÄ™dzy cechami iloÅ›ciowymi oraz jakoÅ›ciowymi przeprowadzony zostaÅ‚ test serii Walda â€“ Wolfowitza:<br/>
H0: rozkÅ‚ad cechy w podgrupach jest jednakowy<br/>
H1: rozkÅ‚ad cechy w podgrupach siÄ™ rÃ³Å¼ni â€“ cecha jest wspÃ³Å‚zaleÅ¼na z cechÄ… grupujÄ…cÄ…<br/>
<br/>

<font size="2">Tablica 7 - Test serii Walda-Wolfowitza wzglÄ™dem zmiennej grupujÄ…cej **Gender**</font>
<center>![Tablica_7](Tablice png/Tablica_7.png)</center/>
<font size="1">Å¹rÃ³dÅ‚o: opracowanie wÅ‚asne za pomocÄ… programu Statistica</font><br/>
<br/>
Dla zmiennej grupujÄ…cej Gender w Tablicy 7, Å¼adna wartoÅ›Ä‡ p-value nie spadÅ‚a poniÅ¼ej 0,05, a wiÄ™c brak podstaw do odrzucenia hipotezy zerowej. PÅ‚eÄ‡ nie rÃ³Å¼nicuje rozkÅ‚adu zmiennych iloÅ›ciowych â€“ ich rozkÅ‚ad jest taki sam dla kobiet oraz mÄ™Å¼czyzn.<br/>
<br/>
<font size="2">Tablica 8 - Test serii Walda-Wolfowitza wzglÄ™dem zmiennej grupujÄ…cej **HasCrCard**</font>
<center>![Tablica_8](Tablice png/Tablica_8.png)</center/>
<font size="1">Å¹rÃ³dÅ‚o: opracowanie wÅ‚asne za pomocÄ… programu Statistica</font><br/>
<br/>
Tablica 8 przedstawia wyniki testu serii Walda â€“ Wolfowitza wzglÄ™dem zmiennej grupujÄ…cej HasCrCard. Grupa 1 sÄ… to klienci posiadajÄ…cy kartÄ™ kredytowÄ…, zaÅ› grupa 2 â€“ klienci bez karty. Niskie p-value moÅ¼emy zaobserwowaÄ‡ dla zmiennej NumOfProducts. NaleÅ¼aÅ‚oby wiÄ™c wyeliminowaÄ‡ z modelu tÄ™ zmiennÄ… bÄ…dÅº teÅ¼ HasCrCard.
<br/>
Dla zmiennej grupujÄ…cej Geography zostaÅ‚y wykonane trzy testy, aby uwzglÄ™dniÄ‡ kaÅ¼dy z trzech wariantÃ³w pochodzenia: HiszpaniÄ™, FrancjÄ™ i Niemcy. W tablicach poniÅ¼ej przedstawione zostaÅ‚y wyniki testÃ³w. 
<br/>

<font size="2">Tablica 9 - Test serii Walda-Wolfowitza wzglÄ™dem zmiennej grupujÄ…cej **Geography - France**</font><br/>
<center>![Tablica_9](Tablice png/Tablica_9.png)</center/>
<font size="1">Å¹rÃ³dÅ‚o: opracowanie wÅ‚asne za pomocÄ… programu Statistica</font><br/> 
<br/>
Odrzucamy hipotezÄ™ zerowÄ… na korzyÅ›Ä‡ hipotezy alternatywnej â€“ rozkÅ‚ad Balance oraz NumOfProductsNew jest wspÃ³Å‚zaleÅ¼ny ze zmiennÄ… grupujÄ…cÄ… Geography. 
<br/>

<font size="2">Tablica 10 - Test serii Walda-Wolfowitza wzglÄ™dem zmiennej grupujÄ…cej **Geography - Germany**</font><br/>
<center>![Tablica_10](Tablice png/Tablica_10.png)</center/>
<font size="1">Å¹rÃ³dÅ‚o: opracowanie wÅ‚asne za pomocÄ… programu Statistica</font><br/>
<br/>
Odrzucamy hipotezÄ™ zerowÄ… na korzyÅ›Ä‡ hipotezy alternatywnej â€“ Balance jest wspÃ³Å‚zaleÅ¼ny ze zmiennÄ… grupujÄ…cÄ… Geography. 
<br/>

<font size="2">Tablica 11 - Test serii Walda-Wolfowitza wzglÄ™dem zmiennej grupujÄ…cej **Geography - Spain**</font><br/>
<center>![Tablica_11](Tablice png/Tablica_11.png)</center/>
<font size="1">Å¹rÃ³dÅ‚o: opracowanie wÅ‚asne za pomocÄ… programu Statistica</font><br/>
<br/>
RÃ³wnieÅ¼ tutaj, wartoÅ›Ä‡ p-value sugeruje odrzucenie hipotezy zerowej, Balance jest wspÃ³Å‚zaleÅ¼ny ze zmiennÄ… grupujÄ…cÄ… Geography. BiorÄ…c pod uwagÄ™ Tabele 9-11, z modelu powinny zostaÄ‡ odrzucone zmienne Geography, bÄ…dÅº Balance i NumOfProducts.
<br/>
<br/>
Za pomocÄ… histogramÃ³w przeprowadzona zostaÅ‚a analiza rozkÅ‚adÃ³w cech. ZostaÅ‚y zestawione ze sobÄ… rozkÅ‚ady zmiennej w zaleÅ¼noÅ›ci od tego, czy klient posiadaÅ‚ konto aktywne czy nieaktywne.
<br/>
<font size="2">Wykres 3-11 - Rozklad wzgledem zmiennej zaleznej</font><br/>
<br/>

<center>![Hist_1](Tablice png/Hist_1.png)
![Hist_2](Tablice png/Hist_2.png)
![Hist_3](Tablice png/Hist_3.png)
![Hist_4](Tablice png/Hist_4.png)
![Hist_5](Tablice png/Hist_5.png)
![Hist_6](Tablice png/Hist_6.png)
![Hist_7](Tablice png/Hist_7.png)
![Hist_8](Tablice png/Hist_8.png)
![Hist_9](Tablice png/Hist_9.png)</center/>
<font size="1">Å¹rÃ³dÅ‚o: opracowanie wÅ‚asne za pomocÄ… programu Statistica</font><br/>
<br/>
W zaprezentowanych powyÅ¼ej wykresach 3, 4, 6, 8, 9 oraz 10, rozkÅ‚ad zmiennej nie rÃ³Å¼ni siÄ™ w zaleÅ¼noÅ›ci od tego czy dany klient posiadaÅ‚ aktywne czy nieaktywne konto. Nie ma wiÄ™c potrzeby dalszej analizy tych zmiennych oraz umieszczania ich w modelu.<br/>
Na podstawie Wykresu 5 dla zmiennej Tenure moÅ¼emy wysnuÄ‡ wniosek, Å¼e wiÄ™ksze szanse na posiadanie aktywnego konta bankowego majÄ… klienci w pierwszych latach od jego zaÅ‚oÅ¼enia. Wykres 7 natomiast ukazuje, Å¼e to mÄ™Å¼czyÅºni czÄ™Å›ciej pozostajÄ… jako aktywni uÅ¼ytkownicy konta niÅ¼ kobiety. RozkÅ‚ad zmiennej Age ukazany na Wykresie 11 pokazuje, Å¼e to osoby starsze majÄ… wiÄ™ksze szanse na posiadanie aktywnego konta bankowego. Klienci powyÅ¼ej 60 roku Å¼ycia (40+18) czÄ™Å›ciej posiadajÄ… aktywne niÅ¼ nieaktywne konto.
<br/>
W Tablicy 12, przedstawione zostaÅ‚y wyniki wspÃ³Å‚czynnika V-Cramera, ktÃ³ry daje moÅ¼liwoÅ›Ä‡ obliczenia zaleÅ¼noÅ›ci rÃ³wnieÅ¼ miÄ™dzy zmiennymi jakoÅ›ciowymi. Z obliczeÅ„ zostaÅ‚y wyÅ‚Ä…czone zmienne iloÅ›ciowe ciÄ…gÅ‚e â€“ Balance oraz EstimatedSalary
<br/>
```{r}

library(rcompanion)
data.frame(`Nazwa Zmiennej` = c("CreditScoreNew","Geography","Gender","AgeNew","Tenure","NumOfProductsNew","HasCrCard"),
           `Wsp. V-Cramer` = c(cramerV(dane1$IsActiveMember, dane1$CreditScoreNew),
                               cramerV(dane1$IsActiveMember, dane1$Geography),
                               cramerV(dane1$IsActiveMember, dane1$Gender),
                               cramerV(dane1$IsActiveMember, dane1$AgeNew),
                               cramerV(dane1$IsActiveMember, dane1$Tenure),
                               cramerV(dane1$IsActiveMember, dane1$NumOfProductsNew),
                               cramerV(dane1$IsActiveMember, dane1$HasCrCard))) %>%
    kbl(caption = "Tablica 12 - WartoÅ›ci wspÃ³Å‚czynnika V-Cramera wzglÄ™dem zmiennej zaleÅ¼nej IsActiveMember") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
Jako Å¼e oczekujemy jak najwyÅ¼szej wartoÅ›ci â€“ sugerujÄ…c siÄ™ wspÃ³Å‚czynnikiem V-Cramera typowalibyÅ›my do odrzucenia zmienne HasCrCard, Geography oraz Gender.
<br/>
W ostatnim kroku postanowiliÅ›my zbudowaÄ‡ model ze wszystkimi zmiennymi objaÅ›niajÄ…cymi. 
```{r}
data.frame(summary(logit0)$coefficients) %>%
  kbl(caption = "Tablica 13 - WartoÅ›ci parametrÃ³w modelu logitowego dla wszystkich zmiennych objaÅ›niajÄ…cych") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
SugerujÄ…c siÄ™ zbudowanym modelem, moÅ¼emy uznaÄ‡, Å¼e istotnymi sÄ… zmienne CreditScore, Gender, Age oraz Tenure. BiorÄ…c od uwagÄ™ to oraz wszystkie powyÅ¼sze rozwaÅ¼ania, zdecydowaliÅ›my siÄ™ wybraÄ‡ do dalszej budowy modelu wÅ‚aÅ›nie te zmienne.
<br>

#### ***Model Logitowy:*** <br/>

Modelujemy prawdopodobieÅ„stwo posiadania przez klienta aktywnego konta â€“ IsActiveMember = 1. Na potrzeby prawidÅ‚owej interpretacji modelu, utworzyliÅ›my wczesniej zmienne NewAge (wiek klienta, pomniejszony o 18 lat) oraz CreditScoreNew (liczba puntkÃ³w, pomniejszona o 350). SposÃ³b kodowania jakoÅ›ciowych zmiennych objaÅ›niajÄ…cych â€“ parametryzacja z poziomem odniesienia. Grupa referencyjna â€“ osiemnastoletnie kobiety, z punktacjÄ… kredytowÄ… rÃ³wnÄ… 350 i nowo otwartym kontem bankowym. W tablicy 14 zaprezentowaliÅ›my model, oszacowany metodÄ… najwiÄ™kszej wiarygodnoÅ›ci. 
<br/>

```{r}
#Model logitowy 2
logit1 <- glm(IsActiveMember ~CreditScoreNew + Gender + AgeNew + Tenure, data=dane1, family=binomial)
data.frame(summary(logit1)$coefficients) %>%
  kbl(caption = "Tablica 14 - WartoÅ›ci parametrÃ³w modelu logitowego dla wybranych zmiennych") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
PostaÄ‡ modelu logitowego wyglÄ…da nastÄ™pujÄ…co:<br/>
<br/>
`lnâ¡(Î² Ì‚/(1-Î² Ì‚ ))=-0.4010+0.0005CreditScoreNew+0.1031Gender+0.0167AgeNew-0.0195Tenure`
<br/>
`Gender {0 - klientkÄ… jest kobieta        1 - klientem jest mÄ™Å¼czyzna}`
<br/>
```{r}
exp(logit1$coefficients)%>%
  kbl(caption = "Tablica 15 - Ilorazy szans dla zmiennych objaÅ›niajÄ…cych oraz wyrazu wolnego") %>%
  kable_classic(full_width = F, html_font = "Cambria")

exp(logit1$coefficients*10)%>%
  kbl(caption = "Tablica 16 - Ilorazy szans dla zmiennych objaÅ›niajÄ…cych oraz wyrazu wolnego(*10)") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
KierujÄ…c siÄ™ wartoÅ›ciami ukazanymi w Tabeli 15, parametry oszacowanego modelu logitowego moÅ¼emy interpretowaÄ‡ w nastÄ™pujÄ…cy sposÃ³b:<br/>
Szansa na pozostanie aktywnym uÅ¼ytkownikiem banku w grupie referencyjnej, czyli osiemnastoletnich kobiet z punktacjÄ… kredytowÄ… rÃ³wnÄ… 350 i nowo otwartym kontem bankowym wynosi 0.663.<br/>	
JeÅ¼eli klientowi banku poprawi siÄ™ zdolnoÅ›Ä‡ kredytowa o 100 punktÃ³w to wtedy bÄ™dzie mieÄ‡ 5.6% wiÄ™kszÄ… szansÄ™ na posiadanie aktywnego konta bankowego, ceteris paribus.<br/>		
MÄ™Å¼czyzna ma 10.85% wiÄ™kszÄ… szansÄ™ na posiadanie aktywnego konta bankowego niÅ¼ kobieta, ceteris paribus.<br/>
O 10 lat starszy klient banku ma 18.13% wiÄ™kszÄ… szansÄ™ na posiadanie aktywnego konta bankowego, ceteris paribus.<br/>		
Z kaÅ¼dym rokiem posiadania konta bankowego szansa jego aktywnoÅ›ci spada o 1.92%, ceteris paribus.<br/>
<br/>

#### ***Model probitowy:*** <br/>

Modele probitowe sÄ… modelami, ktÃ³re rÃ³wnie czÄ™sto stosowane sÄ… jak modele probitowe. Ich funkcja wiÄ…Å¼aca probit ("mat. liczba charakteryzujÄ…ca prawdopodobieÅ„stwo danego zdarzenia" [PWN]). Podobnie jak logit. p. wyraza prawdopodobienstwo w skali majacej dowolne wartosci rzeczywiste. Modele te wyrazaja prawdopodobienstwo zdarzenia jako funkcje czynnikÃ³w ilosciowych i jakosciowych wplywajacych na przebieg tego zdarzenia. W modelu tym nie mozna przedstawic zaleznosci pomiedzy pi ,a xiB w postaci wygodnego wyrazenia analitycznego jak ma to miejsce w modelu logitowym. <br/>
```{r}

#Model probitowy grupa referencyjna - Gender - Male
dane2 <- dane1
#dane2$Geography <- relevel(dane2$Geography, ref = "Germany")
#dane2$Gender <- relevel(dane2$Gender, ref = "Male")
probit0 <- glm(IsActiveMember ~CreditScoreNew + Gender + AgeNew + Tenure,
              data=dane2, family=binomial(link = probit))
summary(probit0)$coefficients%>%
  kbl(caption = "Tablica 17 - WartoÅ›ci parametrÃ³w modelu probitowego dla wybranych zmiennych") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
Powyzej oszacowano parametry modelu probitowego na podstawie takich samych zalozen jak dla modelu logitowego. Parametry modelu probitowego maja takie same znaki (kierunki) jak w przypadku modelu logitowego. Znak ten (stojacy przy zmiennej Xi), okreÅ›la kierunek wpÅ‚ywu zmiennej objaÅ›niajÄ…cej na zmiennÄ… objaÅ›nianÄ…. W wyestymowanym modelu moÅ¼na opisaÄ‡ CreditScoreNew, Gender, AgeNew, Tenure jako stymulanty a Tenure jako destymulantÄ™.
<br/>
```{r}
df_compare = data.frame(Logitowy = data.frame(summary(logit1)$coefficients)[1],
           Probitowy = data.frame(summary(probit0)$coefficients)[1],
           Probitowy1.6 = data.frame(summary(probit0)$coefficients)[1]*1.6,
           Roznica =data.frame(summary(logit1)$coefficients)[1] - (data.frame(summary(probit0)$coefficients)[1]*1.6))
colnames(df_compare) = c("Logitowy","Probitowy","Probitowy1.6","Roznica")
df_compare%>%
  kbl(caption = "Tablica 18 - PorÃ³wnanie rÃ³znicy parametrÃ³w logit = 1.6*probit") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
ZauwaÅ¼alne jest, Å¼e oba modele sÄ… do siebie podobne. Jest tak poniewaÅ¼ dystrybuanty rozkÅ‚adÃ³w listycznego i normalnego sÄ… podobne.  W literaturze doszukaÄ‡ siÄ™ moÅ¼na rÃ³wnaÅ„, ktÃ³re pozwalajÄ… na przeksztaÅ‚cenie parametrÃ³w modelu logitowego na model probitowy. MÃ³wi ono Å¼e B_logit bÄ™dzie zbliÅ¼one do 1.6* B_probit. Udowodniono to w poniÅ¼ej Tablicy wyliczajÄ…c tÄ™ rÃ³Å¼nice dla wszystkich parametrÃ³w omawianego modelu.
<br/>

### ***Ocena porÃ³wnanie zaproponowanych modeli.*** <br/>

#### ***Miary dopasowania - AIC , Pseudo R^2:*** <br/>
Istnieje wiele wariantÃ³w miar dopasowania pseudo-R^2, z ktÃ³rych kaÅ¼da jest odpowiednikiem R^2 dla modeli regresji liniowej. W praktyce wartoÅ›ci R^2 sÄ… niewielkie oraz raczej bliÅ¼sze zeru niÅ¼ jednoÅ›ci. PoniÅ¼ej przedstawiamy dwie miary pseudo R^2 opartych na funkcji wiarygodnoÅ›ci, obliczonych dla omawianego modelu:<br/>
<br/>
`R^2 McFaddena=1-  (lnL_k)/(lnL_0 )- indeks ilorazu wiarygnodnoÅ›ci`
<br/>
`R^2 Cragga-Uhlera=  (1-(L_0/L_k )^(2/n))/(1-(L_0 )^(2/n) ) (wspÃ³Å‚czynnik Nagelkerke'a):`
<br/>
`AIC = 2k-2ln(L(hat)`
<br/>
```{r}
ocena_modelu_dwum <- function(model) {
  kryterium_AIC <- c(model$aic)
  McFadden<-pR2(model)[4]
  Cragg_Uhler<-pR2(model)[6]
  ocena <- data.frame(kryterium_AIC, McFadden, Cragg_Uhler)
  return(ocena)
}
#Ocena modelu, AIC, Pseudo R^2
wyniki_oceny_modeli_logit_probit = rbind(Logit = ocena_modelu_dwum(logit1),
                                         Probit = ocena_modelu_dwum(probit0))
wyniki_oceny_modeli_logit_probit %>%  
  kbl(caption = "Tablica 19 - Kryterium AIC i Oceny pseudo R^2") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
Rozpatrujac zaproponowane modele wedlug omawianych wyÅ¼ej kryteriÃ³w moÅ¼na dostrzec, Å¼e w przypadku obu modeli wartosci sa zblizone. Model probitowy chrakteryzuje sie lepszym kryterium AIC. RÃ³wnieÅ¼  przypadku ocen miar Pseudo R^2 jego wyniki sa lepsze. NaleÅ¼y jednak zauwaÅ¼yc Å¼e otrzymane wartoÅ›ci wybranych miar R2 sÄ… niskie, co jest typowe dla modeli dwumianowych.
<br/>

#### ***Tablica trafnosci i miary predykcji:*** <br/>
Innym sposobem na zbadanie jakoÅ›ci dopasowania modelu do danych jest sprawdzenie, jaka jest trafnoÅ›Ä‡ prognozowania na podstawie modelu. Prognoza opiera siÄ™ na oszacowanym prawdopodobieÅ„stwie ğ‘Ì‚ğ‘–, ktÃ³re jest funkcjÄ… ğ¹(ğ‘¥ğ‘–ğ›½Ì‚). Ze wzglÄ™du na przyjÄ™ty punkt odciÄ™cia, zgodnie z ktÃ³rym prognoza modelu przyjmuje wartoÅ›ci 0 lub 1, generuje siÄ™ tablice trafnoÅ›ci, zestawiajÄ…ca prognozy modelu z obserwacjami rzeczywistymi. Wygenerowane zostaly tablice dla obu proponowanych modeli. <br/>
```{r}
#Tablica trafnosci p* = 0.5
tab_traf <- data.frame(obserwowane=dane2$IsActiveMember, przewidywane=ifelse(logit1$fitted.values>0.5, 1, 0))
tab_traf1 <- data.frame(obserwowane=dane2$IsActiveMember, przewidywane=ifelse(probit0$fitted.values>0.5, 1, 0))
data.frame(table(tab_traf))%>%  
  kbl(caption = "Tablica 20 - Tab. Trafnosci logit p=0,5") %>%
  kable_classic(full_width = F, html_font = "Cambria")
data.frame(table(tab_traf1))%>%  
  kbl(caption = "Tablica 21 - Tab. trafnoÅ›ci probit p=0,5") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
Na podstawie tablicy trafnosci moÅ¼na obliczyc miary trafnosci prognoz, sa to:<br/>
1. Zliczeniowy R2 (Accuracy)  R_Z^2 - (True Positive + True Negative) / N<br/>
2. WskaÅºnik bÅ‚Ä™du (ER-Error Rate)  ER - (False Positive + False Negative) / N<br/>
3. CzuÅ‚oÅ›Ä‡ (Sensitivity)  SENS - TP / (TP +FP)<br/>
4. SwoistoÅ›Ä‡ (Specifity)SPEC  - TN/ (TN + FN)<br/>
5. Dodatnia zdolnoÅ›Ä‡ predykcyjna (Positive Predictive Value)  PPV - TP / (TP + FP)<br/>
6. Ujemna zdolnoÅ›Ä‡ predykcyjna (Negative Predictive Value)  NPV - TN / (TN + FN)<br/>
Wyniki dla obu modeli zestawiono w tablicy 22.<br/>
<br/>
```{r}
#Miary predykcji (tablica trafnoÄ¹â€ºci)
miary_pred <- function(model, Y, p=0.5) {
  tab <- table(obserwowane=Y, przewidywane=ifelse(model$fitted.values>p, 1, 0))
  ACC <- (tab[1,1]+tab[2,2])/sum(tab)
  ER <- (tab[1,2]+tab[2,1])/sum(tab)
  SENS <- tab[2,2]/(tab[2,2]+tab[2,1])
  SPEC <- tab[1,1]/(tab[1,1]+tab[1,2])
  PPV <- tab[2,2]/(tab[2,2]+tab[1,2])
  NPV <- tab[1,1]/(tab[1,1]+tab[2,1])
  miary <- data.frame(ACC, ER, SENS, SPEC, PPV, NPV)
  return(miary)
}
wyniki_miary_pred <- rbind(Logitowy =miary_pred(model=logit1, Y=dane2$IsActiveMember, p=0.5),
                           Probitowy=miary_pred(model=probit0, Y=dane2$IsActiveMember, p=0.5))
t(wyniki_miary_pred) %>%  
  kbl(caption = "Tablica 22 - Miary predykcji na podstawie tablicy trafnosci dla modeli: logit, probit") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
Tablice trafnoÅ›ci wygenerowana zostaÅ‚a stworzona z domyÅ›lnym progiem o wartoÅ›ci 0,5. JeÅ›li jednak zmieniÄ‡ wartoÅ›Ä‡ progu 0,5 na innÄ… rÃ³wnÄ… c (cut-off point), wÃ³wczas zmieni siÄ™ tablica trafnoÅ›ci, a wraz z niÄ… procent bÅ‚Ä™dÃ³w. Warto stosowaÄ‡ innÄ… niÅ¼ 0,5 wartoÅ›Ä‡ progu c, gdy prÃ³ba jest niezbilansowana, to znaczy procent obserwacji, dla ktÃ³rych Y=1, jest znacznie wyÅ¼szy/niÅ¼szy niÅ¼ 50%. Poziom c19 moÅ¼na ustaliÄ‡ na poziomie faktycznego odsetka obserwacji w prÃ³bie, dla ktÃ³rych Y=1 (jednak w przypadku naszej bazy, byÅ‚aby to wartoÅ›Ä‡ zbliÅ¼ona to wielkoÅ›ci domyÅ›lnej). Jest to tak zwana optymalna wartoÅ›Ä‡ graniczna Cramera.<br/>
<br/>
Biorac pod uwage uzyskane wyniki moÅ¼na stwierdzic, Å¼e oba modele radza sobie raczej srednio z zalozonym zadaniem. Procent trafien osiaga wartosci zblizone do 52%. Bledy dla obu modeli wynasza ok 48%.
Czulosc modeli jest na poziomie 61.4% i 61.3% (Zdolnosc do rozpoznania tam gdzie wystepuje zjawisko), Swoistosc - 41,91% i 41,93% (Zdolnosc do rozpoznawania tam gdzie nie wystepuje zjawisko).  PPV - zdolnosc dodatnia predykcji i NPV - negatywna zdolnosc predykcji sa zblizone do 52.9% i 50,5% w obu przypadkach. Wartosci te wskazuja na jak mozna byc pewnym pozytywnego i negatywnego wyniku przeprowadzonej predykcji. <br/>

#### ***Krzywa ROC _ AUC:*** <br/>
Innym sposobem ustalenia progu c jest minimalizacja liczby bÅ‚Ä™dÃ³w klasyfikacji. Jej okreÅ›lenie znacznie uÅ‚atwia krzywa ROC (Receiver Operating Characteristic), ktÃ³ra pokazuje wszystkie kombinacje obu rodzajÃ³w bÅ‚Ä™dÃ³w dla rÃ³Å¼nych wartoÅ›ci punktu odciÄ™cia. Dla naszego modelu zostaÅ‚a ona ukazana na wykresie poniÅ¼ej. <br/>

```{r message=FALSE, warning=FALSE, include=FALSE}
#Funkcja
rocplot = function(rocobj,modeltype){
  ggroc(rocobj, legacy.axes = TRUE)+
    ggtitle(paste("Krzywa ROC", modeltype)) +
    geom_segment(aes(x = 0, xend = 1, y = 0, yend = 1), color="red")+
    geom_hline(aes(yintercept=1), lty=2, color="grey")+
    geom_hline(aes(yintercept=0), lty=2, color="grey")+
    geom_vline(aes(xintercept=1), lty=2, color="grey")+
    geom_vline(aes(xintercept=0), lty=2, color="grey")+
    theme_classic()
}
```

```{r message=FALSE, warning=FALSE}
rocplot(roc(dane2$IsActiveMember, logit1$fitted.values)," - logit")
```
<br/>
Krzywa ROC sÅ‚uÅ¼y rÃ³wnieÅ¼ jako podstawa kolejnej miary dopasowania modelu do danych â€“ pole powierzchni pod krzywÄ… ROC (AUC â€“ Area under ROC). Jej wartoÅ›Ä‡ przyjmuje znaczenia od 0,5, gdy model nie ma Å¼adnej mocy predykcyjnej, do 1 â€“ wtedy model jest idealny. Dla modelu logitowego: `AUC = 0.5381382,  wskaÅºnik Giniâ€™go ğº = 2 âˆ— ğ´ğ‘ˆğ¶ âˆ’ 1 = 0.0762764`
<br/>

```{r message=FALSE, warning=FALSE}
rocplot(roc(dane2$IsActiveMember, probit0$fitted.values)," - probit")
```
<br/>Dla modelu logitowego: `AUC = 0.5380298,  wskaÅºnik Giniâ€™go ğº = 2 âˆ— ğ´ğ‘ˆğ¶ âˆ’ 1 = 0.0760596`<br/>


```{r message=FALSE, warning=FALSE}
pole_AUC_logit<-as.numeric(auc(dane2$IsActiveMember, logit1$fitted.values))
pole_AUC_probit<-as.numeric(auc(dane2$IsActiveMember, probit0$fitted.values))
data.frame(row.names = c("Logit","Probit"),Pole_AUC = rbind(pole_AUC_logit, pole_AUC_probit)) %>%  
  kbl(caption = "Tablica 22 - AUC") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>
Badajac ten sposÃ³b efektywnosci modelu lepiej radzi sobie ponownie logitowy.
<br/>

#### ***Podsumowanie***
  Mimo tego, Å¼e modele logitowe oraz probitowe sa dobre do objasniania zmiennych jakosciowych, a zwÅ‚aszcza do modelowania znajdowania jednostki w pewnym stanie. Niestety prÃ³be zbudowania modelu z dostepnych danych, ktÃ³ry bylby zdolny do dobrej identyfikacji klientÃ³ww potencjalnie naraÅ¼onych na przejscie w status nieaktywnego. Musimy okreslic jako nieudana. Dostepne dane o klientach nie pozwolily na uzyskanie wyniku, ktÃ³ry bylby satysfakcjonujaco wyÅ¼szy i przy wysokiej ilosci prÃ³b wnosilby biznesowa wartosc. I dzieki ktÃ³remu, moÅ¼na by aktywizowac uzytkownikow kont na rÃ³Å¼ne sposoby (np. indywidualne kampanie marketingowo-promocyjne). Sam model radzi sobie niewiele lepiej od osoby ktÃ³ra podejmowala by decyzje o zaklasyfikowaniu danej osoby do kampanii na podstawie rzutu moneta. Dlatego gdyby sytuacja miala miejsce w rzeczywistosci biznesowej rekomendowalibysmy nie wprowadzanie omawianego modelu do uzytku. A sam proces skierowalibysmy na ponowny etap badania zjawiska i identyfikacji wplywu roznych czynnikow na wlasnie ta zmienna. Wynik ten nie jest zaskoczeniem. Sam model nie piorunuje swoja skutecznoscia i utwierdza w przekonaniu, Å¼e *najwaÅ¼niejszym etapem w calym procesie budowania jakiegokolwiek modelu czy analizy jest prawidlowy dobÃ³r i budowa zmiennych samego zestawu zmiennych, poniewaÅ¼ to na nim oparieraja sie wszystkie zastosowane pÃ³zniej rÃ³wnania i metody statystyczne*. . Z informacji zamieszczonych pod zestawem danych na stronie z ktÃ³rej byl on pobrany moÅ¼na takÅ¼e odnalezc informacje. O tym Å¼e zostal on zbudowany do badania prawdopodobienstwa odejscia klientÃ³w z banku, a nie badania ich potencjalnej aktywnosci. <br/>
<br/>
W dalszej czesci przedstawiamy jeszcze prÃ³by zwiekszenia efektywnosci bez pozostawionego komentarza(poniewaÅ¼ wyniki sa zblizone do tych uzyskanych wyzej) a jedynie z wygenerowanymi modelami i statystykami dotyczacymi efektywnosci. <br/>
#### ***PrÃ³by zwiekszenia efektywnosci***<br/>
<br/>
<br/>
Dodanie zmiennej Geography do modelu:<br/>
<br/>
```{r echo=FALSE, message=FALSE, warning=FALSE}
dane2 <- dane1
logit_1 <- glm(IsActiveMember ~CreditScoreNew + Gender + AgeNew + Tenure + Geography, data=dane2, family=binomial)
probit_1 <- glm(IsActiveMember ~CreditScoreNew + Gender + AgeNew + Tenure + Geography,
              data=dane2, family=binomial(link = probit))
summary(logit_1)$coefficients%>%
  kbl(caption = "Model Logitowy") %>%
  kable_classic(full_width = F, html_font = "Cambria")
summary(probit_1)$coefficients%>%
  kbl(caption = "Model Probitowy") %>%
  kable_classic(full_width = F, html_font = "Cambria")
#Tab Traf
tab_traf <- data.frame(obserwowane=dane2$IsActiveMember, przewidywane=ifelse(logit_1$fitted.values>0.5, 1, 0))
tab_traf1 <- data.frame(obserwowane=dane2$IsActiveMember, przewidywane=ifelse(probit_1$fitted.values>0.5, 1, 0))
wyniki_miary_pred <- rbind(Logitowy =miary_pred(model=logit_1, Y=dane2$IsActiveMember, p=0.5),
                           Probitowy=miary_pred(model=probit_1, Y=dane2$IsActiveMember, p=0.5))
t(wyniki_miary_pred) %>%  
  kbl(caption = "Miary predykcji na podstawie tablicy trafnosci dla modeli: logit, probit") %>%
  kable_classic(full_width = F, html_font = "Cambria")
#AUC
pole_AUC_logit<-as.numeric(auc(dane2$IsActiveMember, logit_1$fitted.values))
pole_AUC_probit<-as.numeric(auc(dane2$IsActiveMember, probit_1$fitted.values))
data.frame(row.names = c("Logit","Probit"),Pole_AUC = rbind(pole_AUC_logit, pole_AUC_probit)) %>%  
  kbl(caption = "AUC") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
<br/>Przyjecie wszystkich zmiennych w zestawie danych:<br/>
```{r echo=FALSE, message=FALSE, warning=FALSE}
dane3 <- dane1
logit_1 <- glm(IsActiveMember ~ ., data=dane3, family=binomial)
probit_1 <- glm(IsActiveMember ~ .,
              data=dane3, family=binomial(link = probit))
summary(logit_1)$coefficients%>%
  kbl(caption = "Model Logitowy") %>%
  kable_classic(full_width = F, html_font = "Cambria")
summary(probit_1)$coefficients%>%
  kbl(caption = "Model Probitowy") %>%
  kable_classic(full_width = F, html_font = "Cambria")
#Tab Traf
tab_traf <- data.frame(obserwowane=dane2$IsActiveMember, przewidywane=ifelse(logit_1$fitted.values>0.5, 1, 0))
tab_traf1 <- data.frame(obserwowane=dane2$IsActiveMember, przewidywane=ifelse(probit_1$fitted.values>0.5, 1, 0))
wyniki_miary_pred <- rbind(Logitowy =miary_pred(model=logit_1, Y=dane2$IsActiveMember, p=0.5),
                           Probitowy=miary_pred(model=probit_1, Y=dane2$IsActiveMember, p=0.5))
t(wyniki_miary_pred) %>%  
  kbl(caption = "Miary predykcji na podstawie tablicy trafnosci dla modeli: logit, probit") %>%
  kable_classic(full_width = F, html_font = "Cambria")
#AUC
pole_AUC_logit<-as.numeric(auc(dane2$IsActiveMember, logit_1$fitted.values))
pole_AUC_probit<-as.numeric(auc(dane2$IsActiveMember, probit_1$fitted.values))
data.frame(row.names = c("Logit","Probit"),Pole_AUC = rbind(pole_AUC_logit, pole_AUC_probit)) %>%  
  kbl(caption = "AUC") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```


